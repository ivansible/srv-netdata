---
- name: add package cloud signing key
  apt_key:
    url: https://packagecloud.io/netdata/netdata/gpgkey

- name: add package cloud repository
  apt_repository:
    repo: "deb {{ url }} {{ codename }} main"
    filename: netdata
    mode: 0644
  vars:
    url: https://packagecloud.io/netdata/netdata/ubuntu/
    codename: "{{ ansible_lsb.codename }}"

- name: install netdata package
  apt:
    name: netdata
    state: "{{ srv_netdata_upgrade |bool |ternary('latest', 'present') }}"
  notify: restart netdata service

- name: configure netdata
  template:
    src: netdata/netdata.conf
    dest: /etc/netdata/netdata.conf
    owner: root
    group: root
    mode: 0644
  notify: restart netdata service
  vars:
    plugin_core: 'yes'
    plugin_extra: "{{ srv_netdata_extra_plugins |default(false) |bool |ternary('no','yes') }}"
    plugin_big: "{{ srv_netdata_lowmem |default(false) |bool |ternary('no','yes') }}"
    plugin_dir: "{{ have_dirs |ternary('yes','no') }}"
    have_dirs: "{{ have_disk_dirs or have_rclone_dirs }}"
    have_disk_dirs: "{{ srv_netdata_disk_dirs |default([]) |length > 0 }}"
    have_rclone_dirs: "{{ srv_netdata_rclone_dirs |default([]) |length > 0 }}"

- name: enable netdata service
  systemd:
    name: netdata
    state: started
    enabled: true

- name: open internal netdata port in ferm
  ferm_port:
    port: 19999
    proto: tcp
    zone: internal
    comment: netdata
  tags: skip_ansible_lint
  when: lin_firewall == 'ferm'
...
